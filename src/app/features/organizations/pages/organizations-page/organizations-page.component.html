<p-toast></p-toast>

<div class="orgs-page">
  <p-card>
    <ng-template pTemplate="title">Organizaciones</ng-template>
    <ng-template pTemplate="subtitle">Selecciona o crea un grupo para continuar.</ng-template>
    <div class="actions">
      <p-button label="Crear grupo" icon="pi pi-plus" (onClick)="openCreateDialog()"></p-button>
    </div>
  </p-card>

  <p-card *ngIf="organizations.length === 0">
    <ng-template pTemplate="title">Sin organizaciones</ng-template>
    <p>No tienes organizaciones aun. Crea un grupo para empezar.</p>
    <p-button label="Crear grupo" icon="pi pi-plus" (onClick)="openCreateDialog()"></p-button>
  </p-card>

  <p-card *ngIf="organizations.length > 0">
    <ng-template pTemplate="title">Lista de organizaciones</ng-template>
    <p-table [value]="organizations" [loading]="loading" dataKey="id">
      <ng-template pTemplate="header">
        <tr>
          <th>Nombre</th>
          <th>Codigo</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-org>
        <tr>
          <td>{{ org.name }}</td>
          <td>{{ org.code }}</td>
          <td>
            <span *ngIf="getOrganizationMembershipStatus(org) === 'pending'">
              Tu acceso esta pendiente de aprobacion del owner
            </span>
          </td>
          <td>
            <p-button
              label="Miembros"
              icon="pi pi-users"
              [disabled]="getOrganizationMembershipStatus(org) === 'pending'"
              (onClick)="openMembersDialog(org)"
            ></p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<p-dialog header="Crear grupo" [(visible)]="createDialogOpen" [modal]="true" [closable]="true" [style]="{ width: '420px' }">
  <form [formGroup]="createForm" class="dialog-form">
    <label>Nombre</label>
    <input pInputText formControlName="name" />
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" [text]="true" (onClick)="createDialogOpen=false"></p-button>
    <p-button label="Crear" icon="pi pi-check" (onClick)="createOrganization()"></p-button>
  </ng-template>
</p-dialog>

<p-dialog header="Miembros" [(visible)]="membersDialogOpen" [modal]="true" [style]="{ width: '520px' }">
  <div class="members-header">
    <div class="title">{{ selectedOrganization?.name }}</div>
    <div class="members-actions">
      <p-button label="Roles" icon="pi pi-lock" [outlined]="true" (onClick)="openRolesDialog()"></p-button>
      <p-button label="Invitar" icon="pi pi-user-plus" (onClick)="openAddMember()"></p-button>
    </div>
  </div>
  <div class="members-requests" *ngIf="members.length > 0">
    <span>Solicitudes pendientes: {{ pendingJoinRequestsCount }}</span>
  </div>
  <p-table [value]="members">
    <ng-template pTemplate="header">
      <tr>
        <th>Usuario</th>
        <th>Rol</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-member>
      <tr>
        <td>{{ getMemberLabel(member) }}</td>
        <td>
          <ng-container *ngIf="!isOwner(member); else ownerRole">
            <p-select
              [options]="rolesOptions"
              [ngModel]="getMemberRoleKey(member)"
              (onChange)="updateMemberRole(member, $event.value)"
              placeholder="Rol"
              appendTo="body"
              [disabled]="isMemberPending(member) || !canEditMember(member)"
            ></p-select>
          </ng-container>
          <ng-template #ownerRole>
            <span>{{ getMemberRoleLabel(member) }}</span>
          </ng-template>
        </td>
        <td>{{ getMemberStatusLabel(member) }}</td>
        <td>
          <div class="row-actions">
            <span *ngIf="isCreator(member)">Creador</span>
            <span *ngIf="!isCreator(member) && isOwner(member)">Owner</span>
            <ng-container *ngIf="canManageMembers() && !isCreator(member) && !isOwner(member)">
              <p-button
                label="Aceptar"
                icon="pi pi-check"
                [text]="true"
                [disabled]="!canAcceptReject(member)"
                (onClick)="acceptMember(member)"
              ></p-button>
              <p-button
                label="Rechazar"
                icon="pi pi-times"
                severity="danger"
                [text]="true"
                [disabled]="!canAcceptReject(member)"
                (onClick)="rejectMember(member)"
              ></p-button>
              <p-button
                label="Quitar"
                icon="pi pi-user-minus"
                severity="danger"
                [text]="true"
                [disabled]="!canRemoveMember(member)"
                (onClick)="removeMember(member)"
              ></p-button>
            </ng-container>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog header="Roles" [(visible)]="rolesDialogOpen" [modal]="true" [style]="{ width: '720px' }">
  <div class="members-header">
    <div class="title">Roles de la organizacion</div>
    <p-button label="Nuevo rol" icon="pi pi-plus" (onClick)="openCreateRole()"></p-button>
  </div>
  <p-table [value]="roles">
    <ng-template pTemplate="header">
      <tr>
        <th>Key</th>
        <th>Nombre</th>
        <th>Permisos</th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-role>
      <tr>
        <td>{{ role.key }}</td>
        <td>{{ role.name }}</td>
        <td>{{ role.permissions?.length || 0 }}</td>
        <td class="row-actions">
          <p-button label="Editar" [text]="true" icon="pi pi-pencil" (onClick)="openEditRole(role)"></p-button>
          <p-button
            label="Eliminar"
            [text]="true"
            severity="danger"
            icon="pi pi-trash"
            [disabled]="role.isSystem"
            (onClick)="deleteRole(role)"
          ></p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<p-dialog
  header="Rol"
  [(visible)]="roleEditorOpen"
  [modal]="true"
  [style]="{ width: '720px' }"
>
  <form class="dialog-form">
    <label>
      Key
      <i class="pi pi-info-circle" pTooltip="Identificador interno (slug)." tooltipPosition="top"></i>
    </label>
    <input pInputText [(ngModel)]="roleDraft.key" name="roleKey" [disabled]="roleMode === 'edit'" />

    <label>Nombre</label>
    <input pInputText [(ngModel)]="roleDraft.name" name="roleName" />

    <label>Permisos por modulo</label>
    <div class="permissions-grid">
      <div class="permission-group" *ngFor="let group of permissionsCatalog">
        <div class="permission-title">{{ group.moduleKey }}</div>
        <div class="permission-items">
          <div class="permission-item" *ngFor="let permission of group.permissions">
            <p-checkbox
              [binary]="true"
              [ngModel]="isPermissionSelected(permission)"
              (onChange)="togglePermission(permission, $event.checked)"
              [inputId]="permission"
              name="{{ permission }}"
            ></p-checkbox>
            <label [for]="permission">{{ permission }}</label>
          </div>
        </div>
      </div>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" [text]="true" (onClick)="roleEditorOpen=false"></p-button>
    <p-button label="Guardar" icon="pi pi-check" (onClick)="saveRole()"></p-button>
  </ng-template>
</p-dialog>

<p-dialog header="Invitar miembro" [(visible)]="addMemberDialogOpen" [modal]="true" [style]="{ width: '420px' }">
  <form [formGroup]="addMemberForm" class="dialog-form">
    <label>Email</label>
    <input pInputText type="email" formControlName="email" />
    <label>Rol</label>
    <p-select [options]="rolesOptions" formControlName="role" appendTo="body"></p-select>
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" [text]="true" (onClick)="addMemberDialogOpen=false"></p-button>
    <p-button label="Agregar" icon="pi pi-check" (onClick)="addMember()"></p-button>
  </ng-template>
</p-dialog>
