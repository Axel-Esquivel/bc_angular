<p-toast></p-toast>

<div class="wizard">
  <div class="wizard-header">
    <h2>Crear organizacion</h2>
    <div class="wizard-actions">
      <p-button label="Cancelar" severity="secondary" (onClick)="cancel()"></p-button>
    </div>
  </div>

  <p-card>
    <div class="steps">
      <span [class.active]="stepIndex === 0">1. Organizacion</span>
      <span [class.active]="stepIndex === 1">2. Monedas</span>
      <span [class.active]="stepIndex === 2">3. Paises</span>
      <span [class.active]="stepIndex === 3">4. Companias</span>
      <span [class.active]="stepIndex === 4">5. Sucursales y bodegas</span>
    </div>

    <section *ngIf="stepIndex === 0" class="step">
      <label class="field-label">Nombre de organizacion</label>
      <input pInputText [(ngModel)]="organizationName" placeholder="Nombre" />
    </section>

    <section *ngIf="stepIndex === 1" class="step">
      <label class="field-label">Monedas</label>
      <p-multiSelect
        [options]="currencyOptions"
        [(ngModel)]="currencyIds"
        optionLabel="label"
        optionValue="value"
        appendTo="body"
        display="chip"
      >
        <ng-template pTemplate="footer">
          <div class="select-footer">
            <p-button label="Agregar moneda" icon="pi pi-plus" text (onClick)="openCreateCurrencyDialog()"></p-button>
          </div>
        </ng-template>
      </p-multiSelect>
    </section>

    <section *ngIf="stepIndex === 2" class="step">
      <label class="field-label">Paises</label>
      <p-multiSelect
        [options]="countryOptions"
        [(ngModel)]="countryIds"
        optionLabel="label"
        optionValue="value"
        appendTo="body"
        display="chip"
      >
        <ng-template pTemplate="footer">
          <div class="select-footer">
            <p-button label="Agregar pais" icon="pi pi-plus" text (onClick)="openCreateCountryDialog()"></p-button>
          </div>
        </ng-template>
      </p-multiSelect>
    </section>

    <section *ngIf="stepIndex === 3" class="step">
      <div class="form-grid">
        <div>
          <label class="field-label">Nombre de compania</label>
          <input pInputText [(ngModel)]="newCompanyName" placeholder="Compania" />
        </div>
        <div>
          <label class="field-label">Pais</label>
          <p-select
            [options]="countryOptions"
            [(ngModel)]="newCompanyCountryId"
            optionLabel="label"
            optionValue="value"
            appendTo="body"
            placeholder="Selecciona"
          ></p-select>
        </div>
        <div class="inline-actions">
          <p-button label="Agregar" icon="pi pi-plus" (onClick)="addCompany()"></p-button>
        </div>
      </div>

      <p-table [value]="companies">
        <ng-template pTemplate="header">
          <tr>
            <th>Compania</th>
            <th>Pais</th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-company>
          <tr>
            <td>{{ company.name }}</td>
            <td>{{ company.countryId }}</td>
            <td class="table-actions">
              <p-button icon="pi pi-trash" severity="danger" text (onClick)="removeCompany(company.tempId)"></p-button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>

    <section *ngIf="stepIndex === 4" class="step">
      <div class="form-grid">
        <div>
          <label class="field-label">Compania</label>
          <p-select
            [options]="companyOptions"
            [(ngModel)]="selectedCompanyId"
            appendTo="body"
            placeholder="Selecciona"
          ></p-select>
        </div>
      </div>

      <div class="split">
        <div>
          <h4>Sucursales</h4>
          <div class="form-grid">
            <input pInputText [(ngModel)]="newBranchName" placeholder="Nombre sucursal" />
            <p-select
              [options]="countryOptions"
              [(ngModel)]="newBranchCountryId"
              optionLabel="label"
              optionValue="value"
              appendTo="body"
              placeholder="Pais"
            ></p-select>
            <p-select
              [options]="[{ label: 'Retail', value: 'retail' }, { label: 'Wholesale', value: 'wholesale' }]"
              [(ngModel)]="newBranchType"
              appendTo="body"
              placeholder="Tipo"
            ></p-select>
            <p-button label="Agregar" icon="pi pi-plus" (onClick)="addBranch()"></p-button>
          </div>

          <p-table [value]="selectedCompany?.branches ?? []">
            <ng-template pTemplate="header">
              <tr>
                <th>Sucursal</th>
                <th>Pais</th>
                <th>Tipo</th>
                <th></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-branch>
              <tr>
                <td>{{ branch.name }}</td>
                <td>{{ branch.countryId }}</td>
                <td>{{ branch.type }}</td>
                <td class="table-actions">
                  <p-button icon="pi pi-trash" severity="danger" text (onClick)="removeBranch(branch.tempKey)"></p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <div>
          <h4>Bodegas</h4>
          <div class="form-grid">
            <input pInputText [(ngModel)]="newWarehouseName" placeholder="Nombre bodega" />
            <p-select
              [options]="branchOptions"
              [(ngModel)]="newWarehouseBranchKey"
              appendTo="body"
              placeholder="Sucursal"
            ></p-select>
            <p-button label="Agregar" icon="pi pi-plus" (onClick)="addWarehouse()"></p-button>
          </div>

          <p-table [value]="selectedCompany?.warehouses ?? []">
            <ng-template pTemplate="header">
              <tr>
                <th>Bodega</th>
                <th>Sucursal</th>
                <th></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-warehouse let-i="rowIndex">
              <tr>
                <td>{{ warehouse.name }}</td>
                <td>{{ warehouse.branchTempKey }}</td>
                <td class="table-actions">
                  <p-button icon="pi pi-trash" severity="danger" text (onClick)="removeWarehouse(i)"></p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </section>

    <div class="wizard-footer">
      <p-button label="Atras" severity="secondary" [disabled]="stepIndex === 0" (onClick)="previousStep()"></p-button>
      <p-button
        *ngIf="stepIndex < 4"
        label="Siguiente"
        (onClick)="nextStep()"
      ></p-button>
      <p-button
        *ngIf="stepIndex === 4"
        label="Crear organizacion"
        [disabled]="submitting"
        (onClick)="submit()"
      ></p-button>
    </div>
  </p-card>
</div>

<p-dialog
  header="Nuevo pais"
  [(visible)]="countryDialogOpen"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '28rem' }"
>
  <div class="dialog-body">
    <label>Codigo</label>
    <input pInputText [(ngModel)]="draftCountry.code" placeholder="GT" />
    <label>Nombre</label>
    <input pInputText [(ngModel)]="draftCountry.name" placeholder="Guatemala" />
  </div>
  <div class="dialog-actions">
    <p-button label="Cancelar" severity="secondary" (onClick)="countryDialogOpen = false"></p-button>
    <p-button label="Guardar" [disabled]="savingCountry" (onClick)="saveCountry()"></p-button>
  </div>
</p-dialog>

<p-dialog
  header="Nueva moneda"
  [(visible)]="currencyDialogOpen"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '28rem' }"
>
  <div class="dialog-body">
    <label>Codigo</label>
    <input pInputText [(ngModel)]="draftCurrency.code" placeholder="USD" />
    <label>Nombre</label>
    <input pInputText [(ngModel)]="draftCurrency.name" placeholder="Dolar" />
    <label>Simbolo (opcional)</label>
    <input pInputText [(ngModel)]="draftCurrency.symbol" placeholder="$" />
  </div>
  <div class="dialog-actions">
    <p-button label="Cancelar" severity="secondary" (onClick)="currencyDialogOpen = false"></p-button>
    <p-button label="Guardar" [disabled]="savingCurrency" (onClick)="saveCurrency()"></p-button>
  </div>
</p-dialog>
