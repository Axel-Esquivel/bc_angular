<section class="module-store">
  <header class="module-store__header">
    <div>
      <h1>Tienda de modulos</h1>
      <p>Instala y administra funcionalidades por organizacion.</p>
    </div>
    <div class="module-store__header-actions">
      <p-button
        *ngIf="returnUrl"
        label="Volver al Dashboard"
        icon="pi pi-arrow-left"
        severity="secondary"
        (onClick)="goBack()"
      ></p-button>
      <p-tag *ngIf="organizationId" severity="success" value="Organizacion activa"></p-tag>
      <p-button
        *ngIf="organization && isOwner && organization.setupStatus !== 'completed'"
        label="Finalizar configuracion"
        icon="pi pi-check"
        (onClick)="completeSetup()"
      ></p-button>
    </div>
  </header>

  <div class="module-store__filters" *ngIf="organizationId">
    <div class="filters-grid">
      <div class="filters-search">
        <label class="filters-label">Buscar</label>
        <input
          pInputText
          type="text"
          placeholder="Buscar modulos..."
          [(ngModel)]="searchText"
          (ngModelChange)="onToolbarChange()"
        />
      </div>
      <div class="filters-field">
        <label>Agrupar por</label>
        <p-select
          [options]="groupByOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="groupBy"
          (onChange)="onToolbarChange()"
          appendTo="body"
        ></p-select>
      </div>
      <div class="filters-field">
        <label>Ordenar por</label>
        <p-select
          [options]="sortByOptions"
          optionLabel="label"
          optionValue="value"
          [(ngModel)]="sortBy"
          (onChange)="onToolbarChange()"
          appendTo="body"
        ></p-select>
      </div>
      <div class="filters-field">
        <label>Categorias</label>
        <p-multiSelect
          [options]="categoryOptions"
          optionLabel="label"
          optionValue="value"
          display="chip"
          [(ngModel)]="selectedCategories"
          (onChange)="onToolbarChange()"
          appendTo="body"
          placeholder="Todas"
        ></p-multiSelect>
      </div>
    </div>
  </div>

  <div class="module-store__empty" *ngIf="!organizationId">
    Selecciona una organizacion para ver los modulos instalables.
  </div>

  <div class="module-store__loading" *ngIf="organizationId && isLoading">
    <p-card class="module-card skeleton"></p-card>
    <p-card class="module-card skeleton"></p-card>
    <p-card class="module-card skeleton"></p-card>
  </div>

  <div class="module-store__error" *ngIf="organizationId && !isLoading && errorMessage">
    <span>{{ errorMessage }}</span>
    <p-button label="Reintentar" icon="pi pi-refresh" (onClick)="retryLoad()"></p-button>
  </div>

  <ng-container *ngIf="organizationId && !isLoading && !errorMessage">
    <div class="module-store__grid" *ngIf="groupBy === 'none'">
      <app-module-card
        *ngFor="let module of visibleModules; trackBy: trackByKey"
        [module]="module"
        [isInstalling]="isInstalling(module.key)"
        [isUninstalling]="isUninstalling(module.key)"
        (install)="installModule(module)"
        (uninstall)="uninstallModule(module)"
      ></app-module-card>
    </div>

    <div class="module-store__groups" *ngIf="groupBy !== 'none' && groupedKeys.length > 0">
      <div *ngFor="let groupKey of groupedKeys" class="group-card">
        <div class="group-card__header">
          <div class="group-title">
            <h3>{{ getGroupLabel(groupKey) }}</h3>
            <small>({{ getGroupInstalledCount(groupKey) }}/{{ getGroupTotalCount(groupKey) }} instalados)</small>
          </div>
          <div class="group-actions">
            <ng-container *ngIf="groupBy === 'suite'">
              <p-button
                label="Instalar suite"
                icon="pi pi-download"
                size="small"
                [text]="true"
                [disabled]="!canInstallSuite(groupKey) || isSuiteInstalling(groupKey)"
                [loading]="isSuiteInstalling(groupKey)"
                (onClick)="installSuite(groupKey)"
              ></p-button>
              <p-button
                label="Desinstalar suite"
                icon="pi pi-trash"
                size="small"
                severity="danger"
                [text]="true"
                [disabled]="!canUninstallSuite(groupKey) || isSuiteUninstalling(groupKey)"
                [loading]="isSuiteUninstalling(groupKey)"
                (onClick)="uninstallSuite(groupKey)"
              ></p-button>
            </ng-container>
            <p-button
              [icon]="isGroupCollapsed(groupKey) ? 'pi pi-chevron-down' : 'pi pi-chevron-up'"
              [text]="true"
              size="small"
              (onClick)="toggleGroup(groupKey)"
            ></p-button>
          </div>
        </div>
        <hr class="group-divider" />
        <div class="module-store__grid" *ngIf="!isGroupCollapsed(groupKey)">
          <app-module-card
            *ngFor="let module of groupedModules[groupKey]; trackBy: trackByKey"
            [module]="module"
            [isInstalling]="isInstalling(module.key)"
            [isUninstalling]="isUninstalling(module.key)"
            (install)="installModule(module)"
            (uninstall)="uninstallModule(module)"
          ></app-module-card>
        </div>
      </div>
    </div>
  </ng-container>

  <div class="module-store__empty" *ngIf="organizationId && !isLoading && !errorMessage && !hasVisibleModules()">
    No hay modulos instalables disponibles.
  </div>

  <p-confirmDialog></p-confirmDialog>
</section>
