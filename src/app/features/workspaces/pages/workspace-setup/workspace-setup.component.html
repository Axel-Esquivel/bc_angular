<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="workspace-setup">
  <p-card>
    <ng-template pTemplate="header">
      <h2>Setup de la organizacion</h2>
    </ng-template>

    <div class="setup-steps">
      <div class="setup-step" [class.is-active]="stepIndex === 0">1. Modulos</div>
      <div class="setup-step" [class.is-active]="stepIndex === 1">2. Configuracion base</div>
      <div class="setup-step" [class.is-active]="stepIndex === 2">3. Roles</div>
    </div>

    <section *ngIf="stepIndex === 0">
      <p class="subtitle">Selecciona los modulos que deseas habilitar en esta organizacion.</p>

      <div class="modules-grid" *ngIf="modules.length > 0; else emptyState">
        <button
          type="button"
          class="module-card"
          *ngFor="let module of modules"
          [class.is-active]="isEnabled(module.id)"
          [class.active-module]="isEnabled(module.id)"
          (click)="toggleModule(module)"
        >
          <i class="module-icon pi pi-box"></i>
          <div class="module-name">
            {{ module.name }}
          </div>
          <span
            class="module-status"
            [ngClass]="isEnabled(module.id) ? 'status-active' : 'status-inactive'"
          >
            {{ isEnabled(module.id) ? 'Activo' : 'Instalar' }}
          </span>
        </button>
      </div>
      <ng-template #emptyState>
        <div class="empty-state">No hay modulos disponibles.</div>
      </ng-template>

      <div class="actions">
        <p-button label="Continuar" [disabled]="submitting" (onClick)="continue()"></p-button>
      </div>
    </section>

    <section *ngIf="stepIndex === 1">
      <p class="subtitle">Configura los datos base de la organizacion para continuar.</p>

      <div class="form-grid">
        <div class="form-field">
          <label for="coreCountry">Pais</label>
          <p-select
            inputId="coreCountry"
            [options]="countryOptions"
            optionLabel="label"
            optionValue="id"
            filter
            appendTo="body"
            [(ngModel)]="coreSettings.countryId"
          >
            <ng-template pTemplate="selectedItem" let-value>
              <span>{{ getCountryLabelById(value) || 'Seleccionar' }}</span>
            </ng-template>
            <ng-template pTemplate="item" let-country>
              <div class="select-item">
                <span class="select-title">{{ country.label }}</span>
                <small class="select-meta">{{ country.code }}</small>
              </div>
            </ng-template>
            <ng-template pTemplate="footer">
              <div class="select-footer">
                <p-button
                  label="Agregar pais"
                  icon="pi pi-plus"
                  [text]="true"
                  severity="secondary"
                  (onClick)="openCreateCountryDialog()"
                ></p-button>
              </div>
            </ng-template>
          </p-select>
        </div>
        <div class="form-field">
          <label for="coreCurrency">Moneda base</label>
          <p-select
            inputId="coreCurrency"
            [options]="currencyOptions"
            optionLabel="label"
            optionValue="id"
            filter
            appendTo="body"
            [(ngModel)]="coreSettings.baseCurrencyId"
            (onChange)="onBaseCurrencyChange()"
          >
            <ng-template pTemplate="selectedItem" let-value>
              <span>{{ getCurrencyLabelById(value) || 'Seleccionar' }}</span>
            </ng-template>
            <ng-template pTemplate="item" let-currency>
              <div class="select-item">
                <span class="select-title">{{ currency.label }}</span>
                <small class="select-meta">{{ currency.code }}</small>
              </div>
            </ng-template>
            <ng-template pTemplate="footer">
              <div class="select-footer">
                <p-button
                  label="Agregar moneda"
                  icon="pi pi-plus"
                  [text]="true"
                  severity="secondary"
                  (onClick)="openCreateCurrencyDialog()"
                ></p-button>
              </div>
            </ng-template>
          </p-select>
        </div>
        <div class="form-field">
          <label for="coreCurrencies">Monedas disponibles</label>
          <p-multiSelect
            inputId="coreCurrencies"
            [options]="currencyOptions"
            optionLabel="label"
            optionValue="id"
            filter
            display="chip"
            appendTo="body"
            [(ngModel)]="coreSettings.currencyIds"
            (onChange)="onCurrencyIdsChange()"
          >
            <ng-template pTemplate="item" let-currency>
              <div class="select-item">
                <span class="select-title">{{ currency.label }}</span>
                <small class="select-meta">{{ currency.code }}</small>
              </div>
            </ng-template>
            <ng-template pTemplate="footer">
              <div class="select-footer">
                <p-button
                  label="Agregar moneda"
                  icon="pi pi-plus"
                  [text]="true"
                  severity="secondary"
                  (onClick)="openCreateCurrencyDialog()"
                ></p-button>
              </div>
            </ng-template>
          </p-multiSelect>
        </div>
      </div>

      <div class="list-editor">
        <div class="list-header">
          <h3>Empresas</h3>
          <span class="hint">Agrega las empresas internas para organizar sucursales.</span>
        </div>
        <div class="list-form">
          <input pInputText placeholder="Nombre de la empresa" [(ngModel)]="draftCompanyName" />
          <p-button label="Agregar" icon="pi pi-plus" (onClick)="addCompany()"></p-button>
        </div>
        <p-table *ngIf="structureSettings.companies.length > 0; else emptyCompanies" [value]="structureSettings.companies">
          <ng-template pTemplate="header">
            <tr>
              <th>Nombre</th>
              <th class="actions-col"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-company>
            <tr>
              <td>{{ company.name }}</td>
              <td class="actions-col">
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  severity="danger"
                  ariaLabel="Eliminar empresa"
                  (onClick)="confirmRemoveCompany(company.id)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #emptyCompanies>
          <div class="empty-state">No hay empresas cargadas.</div>
        </ng-template>
      </div>

      <div class="list-editor">
        <div class="list-header">
          <h3>Sucursales</h3>
          <span class="hint">Relaciona sucursales con su empresa.</span>
        </div>
        <div class="list-form">
          <p-select
            [options]="structureSettings.companies"
            optionLabel="name"
            optionValue="id"
            placeholder="Empresa"
            appendTo="body"
            [(ngModel)]="draftBranchCompanyId"
          ></p-select>
          <input pInputText placeholder="Nombre de la sucursal" [(ngModel)]="draftBranchName" />
          <p-button label="Agregar" icon="pi pi-plus" (onClick)="addBranch()"></p-button>
        </div>
        <p-table *ngIf="structureSettings.branches.length > 0; else emptyBranches" [value]="structureSettings.branches">
          <ng-template pTemplate="header">
            <tr>
              <th>Sucursal</th>
              <th>Empresa</th>
              <th class="actions-col"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-branch>
            <tr>
              <td>{{ branch.name }}</td>
              <td>{{ getCompanyName(branch.companyId) }}</td>
              <td class="actions-col">
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  severity="danger"
                  ariaLabel="Eliminar sucursal"
                  (onClick)="confirmRemoveBranch(branch.id)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #emptyBranches>
          <div class="empty-state">No hay sucursales cargadas.</div>
        </ng-template>
      </div>

      <div class="list-editor">
        <div class="list-header">
          <h3>Bodegas</h3>
          <span class="hint">Relaciona bodegas con sus sucursales.</span>
        </div>
        <div class="list-form">
          <p-select
            [options]="structureSettings.branches"
            optionLabel="name"
            optionValue="id"
            placeholder="Sucursal"
            appendTo="body"
            [(ngModel)]="draftWarehouseBranchId"
          ></p-select>
          <input pInputText placeholder="Nombre de la bodega" [(ngModel)]="draftWarehouseName" />
          <p-button label="Agregar" icon="pi pi-plus" (onClick)="addWarehouse()"></p-button>
        </div>
        <p-table *ngIf="structureSettings.warehouses.length > 0; else emptyWarehouses" [value]="structureSettings.warehouses">
          <ng-template pTemplate="header">
            <tr>
              <th>Bodega</th>
              <th>Sucursal</th>
              <th class="actions-col"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-warehouse>
            <tr>
              <td>{{ warehouse.name }}</td>
              <td>{{ getBranchName(warehouse.branchId) }}</td>
              <td class="actions-col">
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  severity="danger"
                  ariaLabel="Eliminar bodega"
                  (onClick)="confirmRemoveWarehouse(warehouse.id)"
                ></p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <ng-template #emptyWarehouses>
          <div class="empty-state">No hay bodegas cargadas.</div>
        </ng-template>
      </div>

      <div class="actions">
        <p-button label="Volver" severity="secondary" (onClick)="goBack()"></p-button>
        <p-button label="Guardar y continuar" [disabled]="submitting" (onClick)="saveCoreSettings()"></p-button>
      </div>
    </section>

    <section *ngIf="stepIndex === 2">
      <p class="subtitle">Configura roles y permisos si lo necesitas. Este paso es opcional.</p>
      <div class="roles-placeholder">
        <p>Podras administrar roles desde la configuracion de la organizacion.</p>
      </div>
      <div class="actions">
        <p-button label="Volver" severity="secondary" (onClick)="goBack()"></p-button>
        <p-button label="Finalizar" [disabled]="submitting" (onClick)="finishSetup()"></p-button>
      </div>
    </section>
  </p-card>
</div>

<p-dialog
  header="Agregar pais"
  [(visible)]="countryDialogOpen"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [style]="{ width: '420px' }"
>
  <div class="dialog-grid">
    <div class="form-field">
      <label>Codigo</label>
      <input pInputText placeholder="GT" [(ngModel)]="draftCountry.code" />
    </div>
    <div class="form-field">
      <label>Nombre</label>
      <input pInputText placeholder="Guatemala" [(ngModel)]="draftCountry.name" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (onClick)="countryDialogOpen = false"></p-button>
    <p-button label="Guardar" [disabled]="savingCountry" (onClick)="saveCountry()"></p-button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Agregar moneda"
  [(visible)]="currencyDialogOpen"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [style]="{ width: '420px' }"
>
  <div class="dialog-grid">
    <div class="form-field">
      <label>Codigo</label>
      <input pInputText placeholder="USD" [(ngModel)]="draftCurrency.code" />
    </div>
    <div class="form-field">
      <label>Nombre</label>
      <input pInputText placeholder="Dolar" [(ngModel)]="draftCurrency.name" />
    </div>
    <div class="form-field">
      <label>Simbolo</label>
      <input pInputText placeholder="$" [(ngModel)]="draftCurrency.symbol" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (onClick)="currencyDialogOpen = false"></p-button>
    <p-button label="Guardar" [disabled]="savingCurrency" (onClick)="saveCurrency()"></p-button>
  </ng-template>
</p-dialog>
