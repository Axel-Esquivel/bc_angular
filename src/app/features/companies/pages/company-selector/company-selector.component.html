<p-toast></p-toast>

<div class="company-selector">
  <div class="page-header">
    <div>
      <h1>Selecciona tu compania</h1>
      <div class="breadcrumbs">Organizacion &gt; Compania</div>
    </div>
    <p-button label="Volver" icon="pi pi-arrow-left" [text]="true" (onClick)="goBack()"></p-button>
  </div>

  <p-card>
    <ng-template pTemplate="title">Selector de compania</ng-template>
    <ng-template pTemplate="subtitle">Elige la compania activa para continuar.</ng-template>
    <div class="selector-grid">
      <div class="field">
        <label>Compania</label>
        <p-select
          [options]="companies"
          [(ngModel)]="selectedCompany"
          optionLabel="name"
          [showClear]="true"
          placeholder="Seleccionar"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-company>
            <div class="option-item" *ngIf="company">
              <div class="option-title">{{ company.name }}</div>
              <small class="option-meta" *ngIf="company.legalName">{{ company.legalName }}</small>
            </div>
            <span *ngIf="!company">Seleccionar</span>
          </ng-template>
          <ng-template pTemplate="item" let-company>
            <div class="option-item">
              <div class="option-title">{{ company.name }}</div>
              <small class="option-meta" *ngIf="company.legalName">{{ company.legalName }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="footer">
            <div class="select-footer">
              <p-button
                label="Crear compania"
                icon="pi pi-plus"
                [text]="true"
                severity="secondary"
                (onClick)="openCreateCompanyDialog()"
              ></p-button>
            </div>
          </ng-template>
        </p-select>
      </div>
    </div>
    <div class="actions">
      <p-button
        label="Continuar"
        icon="pi pi-arrow-right"
        [disabled]="!selectedCompany?.id || submitting"
        (onClick)="selectCompany()"
      ></p-button>
    </div>
  </p-card>
</div>

<p-dialog header="Crear compania" [(visible)]="createCompanyDialogOpen" [modal]="true" [style]="{ width: '720px' }">
  <form [formGroup]="createCompanyForm" class="dialog-form">
    <label>Nombre</label>
    <input pInputText formControlName="name" />

    <label>Pais donde opera</label>
    <div class="inline-row">
      <p-select
        [options]="countryOptions"
        [formControl]="operatingCountryControl"
        placeholder="Seleccionar"
        appendTo="body"
      ></p-select>
      <p-button label="Agregar" icon="pi pi-plus" severity="secondary" (onClick)="addOperatingCountry()"></p-button>
    </div>
    <div class="tag-list" *ngIf="createCompanyForm.controls.operatingCountryIds.value.length > 0">
      <span class="tag" *ngFor="let countryId of createCompanyForm.controls.operatingCountryIds.value">
        {{ getEnterpriseCountryLabel(countryId) }}
        <button type="button" class="tag-remove" (click)="removeOperatingCountry(countryId)">x</button>
      </span>
    </div>

    <div class="section">
      <h4>Empresas</h4>
      <div class="empty-state" *ngIf="enterpriseDrafts.length === 0">No hay empresas agregadas.</div>
      <div class="enterprise-list" *ngIf="enterpriseDrafts.length > 0">
        <div class="enterprise-item" *ngFor="let enterprise of enterpriseDrafts">
          <div>
            <div class="option-title">{{ enterprise.name }}</div>
            <small class="option-meta">{{ getEnterpriseCountryLabel(enterprise.countryId) }}</small>
          </div>
          <div class="option-meta">{{ getEnterpriseCurrencyLabel(enterprise.defaultCurrencyId) }}</div>
          <p-button icon="pi pi-times" [text]="true" severity="danger" (onClick)="removeEnterprise(enterprise.id)"></p-button>
        </div>
      </div>

      <div class="enterprise-form" [formGroup]="enterpriseForm">
        <label>Nombre de empresa</label>
        <input pInputText formControlName="name" />

        <label>Pais</label>
        <p-select
          [options]="countryOptions"
          formControlName="countryId"
          placeholder="Seleccionar"
          appendTo="body"
        ></p-select>

        <label>Moneda permitida</label>
        <div class="inline-row">
          <p-select
            [options]="currencyOptions"
            [formControl]="enterpriseCurrencyControl"
            placeholder="Seleccionar"
            appendTo="body"
          ></p-select>
          <p-button label="Agregar" icon="pi pi-plus" severity="secondary" (onClick)="addEnterpriseCurrency()"></p-button>
        </div>
        <div class="tag-list" *ngIf="enterpriseForm.controls.currencyIds.value.length > 0">
          <span class="tag" *ngFor="let currencyId of enterpriseForm.controls.currencyIds.value">
            {{ getEnterpriseCurrencyLabel(currencyId) }}
            <button type="button" class="tag-remove" (click)="removeEnterpriseCurrency(currencyId)">x</button>
          </span>
        </div>

        <label>Moneda base de la empresa</label>
        <p-select
          [options]="enterpriseDefaultCurrencyOptions"
          formControlName="defaultCurrencyId"
          placeholder="Seleccionar"
          appendTo="body"
        ></p-select>

        <p-button label="Agregar empresa" icon="pi pi-plus" severity="secondary" (onClick)="addEnterprise()"></p-button>
      </div>
    </div>

    <label>Empresa por defecto</label>
    <p-select
      [options]="enterpriseDrafts"
      formControlName="defaultEnterpriseId"
      optionLabel="name"
      optionValue="id"
      placeholder="Seleccionar"
      appendTo="body"
      (onChange)="onDefaultEnterpriseChange()"
    ></p-select>

    <label>Moneda por defecto</label>
    <p-select
      [options]="defaultCurrencyOptions"
      formControlName="defaultCurrencyId"
      placeholder="Seleccionar"
      appendTo="body"
    ></p-select>
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" [text]="true" (onClick)="createCompanyDialogOpen=false"></p-button>
    <p-button label="Crear" icon="pi pi-check" [disabled]="submitting" (onClick)="createCompany()"></p-button>
  </ng-template>
</p-dialog>
