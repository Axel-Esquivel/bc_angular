
<div class="company-selector">
  <div class="page-header">
    <div>
      <h1>Selecciona tu compania</h1>
      <div class="breadcrumbs">Organizacion &gt; Compania</div>
    </div>
    <p-button label="Volver" icon="pi pi-arrow-left" [text]="true" (onClick)="goBack()"></p-button>
  </div>

  <p-card>
    <ng-template pTemplate="title">Selector de compania</ng-template>
    <ng-template pTemplate="subtitle">Elige la compania activa para continuar.</ng-template>
    <div class="selector-grid">
      <div class="field">
        <label>Compania</label>
        <p-select
          [options]="companies"
          [formControl]="selectedCompanyControl"
          optionLabel="name"
          [showClear]="true"
          placeholder="Seleccionar"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-company>
            <div class="option-item" *ngIf="company">
              <div class="option-title">{{ company.name }}</div>
              <small class="option-meta" *ngIf="company.legalName">{{ company.legalName }}</small>
            </div>
            <span *ngIf="!company">Seleccionar</span>
          </ng-template>
          <ng-template pTemplate="item" let-company>
            <div class="option-item">
              <div class="option-title">{{ company.name }}</div>
              <small class="option-meta" *ngIf="company.legalName">{{ company.legalName }}</small>
            </div>
          </ng-template>
          <ng-template pTemplate="footer">
            <div class="select-footer">
              <p-button
                label="Crear compania"
                icon="pi pi-plus"
                [text]="true"
                severity="secondary"
                (onClick)="openCreateCompanyDialog()"
              ></p-button>
            </div>
          </ng-template>
        </p-select>
      </div>
    </div>
    <div class="actions">
      <p-button
        label="Continuar"
        icon="pi pi-arrow-right"
        [disabled]="!selectedCompany?.id || submitting"
        (onClick)="selectCompany()"
      ></p-button>
    </div>
  </p-card>
</div>

<p-dialog header="Crear compañía (v2)" [(visible)]="createCompanyDialogOpen" [modal]="true" [style]="{ width: '720px' }">
  <form [formGroup]="createForm" (ngSubmit)="onSubmitCreate()" class="dialog-form p-fluid flex flex-column gap-3">
    <div class="form-field">
      <label>Nombre</label>
      <input pInputText class="w-full" formControlName="name" />
      <small class="error" *ngIf="createForm.controls.name.touched && createForm.controls.name.invalid">
        Nombre requerido.
      </small>
    </div>

    <div class="form-field">
      <label>Paises</label>
      <p-multiselect
        class="w-full"
        [options]="countryOptions"
        optionLabel="name"
        optionValue="_id"
        formControlName="countryIds"
        placeholder="Seleccionar paises"
        display="chip"
        [filter]="true"
        emptyMessage="No results found"
        appendTo="body"
      ></p-multiselect>
      <small class="error" *ngIf="createForm.controls.countryIds.touched && createForm.controls.countryIds.invalid">
        Selecciona al menos un pais.
      </small>
    </div>

    <div class="form-field">
      <label>Monedas</label>
      <p-multiselect
        class="w-full"
        [options]="currencyOptions"
        optionLabel="name"
        optionValue="_id"
        formControlName="currencyIds"
        placeholder="Seleccionar monedas"
        display="chip"
        [filter]="true"
        emptyMessage="No results found"
        appendTo="body"
      ></p-multiselect>
      <small class="error" *ngIf="createForm.controls.currencyIds.touched && createForm.controls.currencyIds.invalid">
        Selecciona al menos una moneda.
      </small>
    </div>

    <div class="form-field">
      <label>Moneda por defecto</label>
      <p-select
        class="w-full"
        [options]="defaultCurrencyOptions"
        optionLabel="name"
        optionValue="_id"
        formControlName="defaultCurrencyId"
        placeholder="Seleccionar"
        appendTo="body"
      ></p-select>
      <small class="error" *ngIf="createForm.controls.defaultCurrencyId.touched && createForm.controls.defaultCurrencyId.invalid">
        Moneda por defecto requerida.
      </small>
    </div>

    <div class="form-field">
      <label>Empresa por defecto</label>
      <p-select
        class="w-full"
        [options]="unitOptions"
        optionLabel="name"
        optionValue="id"
        formControlName="defaultEnterpriseId"
        placeholder="Seleccionar"
        appendTo="body"
        (onChange)="onDefaultEnterpriseChange()"
      ></p-select>
    </div>

    <div class="accordion-section" *ngIf="selectedCountries.length > 0">
      <h4>Empresas por pais</h4>
      <p-accordion [multiple]="true">
        <p-accordion-panel *ngFor="let country of selectedCountries">
          <p-accordion-header>
            <div class="accordion-header">
              <div class="accordion-title">
                <span>{{ country.name }}</span>
                <small *ngIf="country.code">({{ country.code }})</small>
              </div>
              <p-button
                icon="pi pi-plus"
                text
                rounded
                severity="secondary"
                (onClick)="onAddUnitClick($event, country._id)"
              ></p-button>
            </div>
          </p-accordion-header>
          <p-accordion-content>
            <div class="country-units" [formGroup]="getCountryGroup(country._id)">
              <div class="empty-state" *ngIf="getCountryUnits(country._id).length === 0">
                No hay empresas agregadas.
              </div>
              <div class="unit-list" *ngIf="getCountryUnits(country._id).length > 0">
                <div class="unit-card" *ngFor="let unit of getCountryUnits(country._id)" [formGroup]="unit">
                  <div class="form-field">
                    <label>Nombre de empresa</label>
                    <input pInputText class="w-full" formControlName="name" />
                    <small class="error" *ngIf="unit.controls.name.touched && unit.controls.name.invalid">
                      Nombre requerido.
                    </small>
                  </div>

                  <div class="form-field">
                    <label>Monedas permitidas</label>
                    <p-multiselect
                      class="w-full"
                      [options]="allowedCurrencies"
                      optionLabel="name"
                      optionValue="_id"
                      formControlName="allowedCurrencyIds"
                      placeholder="Seleccionar monedas"
                      display="chip"
                      [filter]="true"
                      emptyMessage="No results found"
                      appendTo="body"
                      (onChange)="syncUnitBaseCurrency(unit)"
                    ></p-multiselect>
                    <small class="error" *ngIf="unit.controls.allowedCurrencyIds.touched && unit.controls.allowedCurrencyIds.invalid">
                      Selecciona al menos una moneda.
                    </small>
                  </div>

                  <div class="form-field">
                    <label>Moneda base</label>
                    <p-select
                      class="w-full"
                      [options]="getUnitCurrencyOptions(unit)"
                      optionLabel="name"
                      optionValue="_id"
                      formControlName="baseCurrencyId"
                      placeholder="Seleccionar"
                      appendTo="body"
                    ></p-select>
                    <small class="error" *ngIf="unit.controls.baseCurrencyId.touched && unit.controls.baseCurrencyId.invalid">
                      Moneda base requerida.
                    </small>
                  </div>

                  <div class="unit-actions">
                    <p-button
                      icon="pi pi-trash"
                      text
                      severity="danger"
                      (onClick)="removeCompanyUnit(country._id, unit.controls.id.value)"
                    ></p-button>
                  </div>
                </div>
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      </p-accordion>
    </div>
    <div class="dialog-actions">
      <p-button type="button" label="Cancelar" [text]="true" (onClick)="createCompanyDialogOpen=false"></p-button>
      <p-button type="submit" label="Crear" icon="pi pi-check" [disabled]="submitting" (onClick)="onCreateClick()"></p-button>
    </div>
  </form>
</p-dialog>
