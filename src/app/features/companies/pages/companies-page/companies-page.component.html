<p-toast></p-toast>

<div class="page">
  <div class="page-header">
    <div>
      <h1>Companias</h1>
      <div class="breadcrumbs">Organizacion &gt; Companias</div>
    </div>
    <p-button label="Crear compania" icon="pi pi-plus" (onClick)="openCreateDialog()"></p-button>
  </div>

  <p-card>
    <p-table [value]="companies" [loading]="loading">
      <ng-template pTemplate="header">
        <tr>
          <th>Compania</th>
          <th>Pais base</th>
          <th>Moneda base</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-company>
        <tr>
          <td>{{ company.name }}</td>
          <td>{{ company.baseCountryId }}</td>
          <td>{{ company.baseCurrencyId }}</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<p-dialog header="Crear compania" [(visible)]="createDialogOpen" [modal]="true" [style]="{ width: '760px' }">
  <form [formGroup]="createForm" class="dialog-form p-fluid flex flex-column gap-3">
    <div class="form-field">
      <label>Nombre</label>
      <input pInputText class="w-full" formControlName="name" />
    </div>

    <div class="form-field">
      <label>Nombre legal</label>
      <input pInputText class="w-full" formControlName="legalName" />
    </div>

    <div class="form-field">
      <label>Tax ID</label>
      <input pInputText class="w-full" formControlName="taxId" />
    </div>

    <div class="form-field">
      <label>Paises donde opera</label>
      <p-multiselect
        class="w-full"
        [options]="countryOptions"
        optionLabel="name"
        optionValue="_id"
        formControlName="operatingCountryIds"
        placeholder="Seleccionar paises"
        display="chip"
        [filter]="true"
        emptyMessage="No results found"
        appendTo="body"
      ></p-multiselect>
    </div>

    <div class="form-field">
      <label>Monedas permitidas</label>
      <p-multiselect
        class="w-full"
        [options]="currencyOptions"
        optionLabel="name"
        optionValue="_id"
        formControlName="allowedCurrencyIds"
        placeholder="Seleccionar monedas"
        display="chip"
        [filter]="true"
        emptyMessage="No results found"
        appendTo="body"
      ></p-multiselect>
    </div>

    <div class="form-field">
      <label>Moneda por defecto</label>
      <p-select
        class="w-full"
        [options]="defaultCurrencyOptions"
        optionLabel="name"
        optionValue="_id"
        formControlName="defaultCurrencyId"
        placeholder="Seleccionar"
        appendTo="body"
      ></p-select>
    </div>

    <div class="form-field">
      <label>Empresa por defecto</label>
      <p-select
        class="w-full"
        [options]="unitOptions"
        optionLabel="name"
        optionValue="id"
        formControlName="defaultEnterpriseId"
        placeholder="Seleccionar"
        appendTo="body"
        (onChange)="onDefaultEnterpriseChange()"
      ></p-select>
    </div>

    <div class="accordion-section" *ngIf="selectedCountries.length > 0">
      <h4>Empresas por pais</h4>
      <p-accordion [multiple]="true">
        <p-accordion-panel *ngFor="let country of selectedCountries">
          <p-accordion-header>
            <div class="accordion-header">
              <div class="accordion-title">
                <span>{{ country.name }}</span>
                <small *ngIf="country.code">({{ country.code }})</small>
              </div>
              <p-button
                icon="pi pi-plus"
                text
                rounded
                severity="secondary"
                (onClick)="onAddUnitClick($event, country._id)"
              ></p-button>
            </div>
          </p-accordion-header>
          <p-accordion-content>
            <div class="country-units" [formGroup]="getCountryGroup(country._id)">
              <div class="empty-state" *ngIf="getCountryUnits(country._id).length === 0">
                No hay empresas agregadas.
              </div>
              <div class="unit-list" *ngIf="getCountryUnits(country._id).length > 0">
                <div class="unit-card" *ngFor="let unit of getCountryUnits(country._id)" [formGroup]="unit">
                  <div class="form-field">
                    <label>Nombre de empresa</label>
                    <input pInputText class="w-full" formControlName="name" />
                  </div>

                  <div class="form-field">
                    <label>Monedas permitidas</label>
                    <p-multiselect
                      class="w-full"
                      [options]="allowedCurrencies"
                      optionLabel="name"
                      optionValue="_id"
                      formControlName="currencyIds"
                      placeholder="Seleccionar monedas"
                      display="chip"
                      [filter]="true"
                      emptyMessage="No results found"
                      appendTo="body"
                    ></p-multiselect>
                  </div>

                  <div class="form-field">
                    <label>Moneda base</label>
                    <p-select
                      class="w-full"
                      [options]="allowedCurrencies"
                      optionLabel="name"
                      optionValue="_id"
                      formControlName="defaultCurrencyId"
                      placeholder="Seleccionar"
                      appendTo="body"
                    ></p-select>
                  </div>

                  <div class="unit-actions">
                    <p-button
                      icon="pi pi-trash"
                      text
                      severity="danger"
                      (onClick)="removeCompanyUnit(country._id, unit.controls.id.value)"
                    ></p-button>
                  </div>
                </div>
              </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      </p-accordion>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" [text]="true" (onClick)="createDialogOpen=false"></p-button>
    <p-button label="Crear" icon="pi pi-check" [disabled]="submitting" (onClick)="createCompany()"></p-button>
  </ng-template>
</p-dialog>
