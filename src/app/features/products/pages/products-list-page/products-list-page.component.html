<p-card *ngIf="contextMissing" class="empty-state">
  <h3>Selecciona un contexto</h3>
  <p>Elige una empresa para cargar el catálogo.</p>
</p-card>
<div class="page-header">
  <div>
    <h2>Productos</h2>
    <p>Gestiona el catálogo de productos.</p>
  </div>
  <p-button label="Nuevo" icon="pi pi-plus" (onClick)="openCreate()" [disabled]="contextMissing"></p-button>
</div>

<p-card *ngIf="!contextMissing">
  <form class="filters" [formGroup]="filtersForm" (ngSubmit)="loadProducts()">
    <div class="filter-item">
      <label for="search">Búsqueda</label>
      <input pInputText id="search" type="text" formControlName="search" placeholder="Nombre, SKU o código" />
    </div>
    <div class="filter-item">
      <label for="category">Categoría</label>
      <p-select
        inputId="category"
        [options]="categoryOptions"
        optionLabel="label"
        optionValue="value"
        formControlName="category"
        placeholder="Todas"
        appendTo="body"
      ></p-select>
    </div>
    <div class="actions">
      <p-button type="submit" label="Aplicar" icon="pi pi-search"></p-button>
      <p-button label="Limpiar" severity="secondary" (onClick)="onResetFilters()"></p-button>
    </div>
  </form>
</p-card>

<p-card *ngIf="!contextMissing">
  <p-table [value]="products" [loading]="loading" dataKey="id">
    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>SKU</th>
        <th>Código</th>
        <th>Precio</th>
        <th>Estado</th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-product>
      <tr>
        <td>{{ product.name }}</td>
        <td>{{ product.sku || '-' }}</td>
        <td>{{ product.barcode || '-' }}</td>
        <td>{{ product.price | number: '1.2-2' }}</td>
        <td>
          <span class="status" [class.inactive]="!product.isActive">{{ product.isActive ? 'Activo' : 'Inactivo' }}</span>
        </td>
        <td class="actions">
          <p-button
            label="Editar"
            icon="pi pi-pencil"
            size="small"
            severity="secondary"
            (onClick)="openEdit(product)"
          ></p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<p-dialog
  [(visible)]="dialogVisible"
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [style]="{ width: '38rem' }"
  [header]="editingProduct ? 'Editar producto' : 'Nuevo producto'"
>
  <div class="dialog-cards">
    <p-card>
      <ng-template pTemplate="title">Producto</ng-template>
      <div class="product-dialog" [formGroup]="productForm">
        <p-floatLabel class="field">
          <input pInputText id="name" type="text" formControlName="name" />
          <label for="name">Nombre</label>
        </p-floatLabel>
        <p-floatLabel class="field">
          <input pInputText id="category" type="text" formControlName="category" />
          <label for="category">Categoría</label>
        </p-floatLabel>
        <div class="field toggle">
          <label for="isActive">Activo</label>
          <p-toggleSwitch inputId="isActive" formControlName="isActive"></p-toggleSwitch>
        </div>
      </div>
    </p-card>

    <p-card>
      <ng-template pTemplate="title">
        <div class="variants-card-header">
          <span>Variantes</span>
          <p-button
            *ngIf="enableVariants"
            icon="pi pi-plus"
            label="Agregar"
            size="small"
            (onClick)="openVariantCreate()"
          ></p-button>
        </div>
      </ng-template>

      <p-accordion expandIcon="pi pi-chevron-down" collapseIcon="pi pi-chevron-up">
        <p-accordion-panel [value]="0">
          <p-accordion-header>
            <div class="variant-header">
              <span class="variant-title">
                {{ defaultVariantForm.controls.name.value || 'Variante default' }}
              </span>
              <div class="variant-meta">
                <span>SKU: {{ defaultVariantForm.controls.sku.value || 'Sin SKU' }}</span>
                <span>UoM: {{ defaultVariantForm.controls.uomId.value || '-' }}</span>
                <span>Precio: {{ defaultVariantForm.controls.price.value | number: '1.2-2' }}</span>
              </div>
            </div>
          </p-accordion-header>
          <p-accordion-content>
            <div class="product-dialog" [formGroup]="defaultVariantForm">
              <p-floatLabel class="field">
                <input pInputText id="variantName" type="text" formControlName="name" />
                <label for="variantName">Nombre de variante</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <input pInputText id="sku" type="text" formControlName="sku" />
                <label for="sku">SKU</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <input pInputText id="barcodes" type="text" formControlName="barcodes" />
                <label for="barcodes">Códigos de barras (separados por coma)</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <input pInputText id="uomId" type="text" formControlName="uomId" />
                <label for="uomId">Unidad de medida</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <p-inputNumber
                  inputId="price"
                  formControlName="price"
                  [min]="0"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                ></p-inputNumber>
                <label for="price">Precio</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <p-inputNumber
                  inputId="minStock"
                  formControlName="minStock"
                  [min]="0"
                  [minFractionDigits]="0"
                  [maxFractionDigits]="0"
                ></p-inputNumber>
                <label for="minStock">Stock mínimo</label>
              </p-floatLabel>
            </div>
          </p-accordion-content>
        </p-accordion-panel>

        <p-accordion-panel *ngFor="let group of variantsFormArray.controls; let i = index" [value]="i + 1">
          <p-accordion-header>
            <div class="variant-header">
              <span class="variant-title">
                {{ group.controls.name.value || ('Variante adicional ' + (i + 1)) }}
              </span>
              <div class="variant-meta">
                <span>SKU: {{ group.controls.sku.value || 'Sin SKU' }}</span>
                <span>UoM: {{ group.controls.uomId.value || '-' }}</span>
                <span>Precio: {{ group.controls.price.value | number: '1.2-2' }}</span>
              </div>
              <span class="variant-header-actions" (click)="$event.stopPropagation()">
                <p-button
                  icon="pi pi-trash"
                  severity="danger"
                  size="small"
                  text="true"
                  (onClick)="removeVariant(i)"
                ></p-button>
              </span>
            </div>
          </p-accordion-header>
          <p-accordion-content>
            <div class="product-dialog" [formGroup]="group">
              <p-floatLabel class="field">
                <input pInputText type="text" formControlName="name" />
                <label>Nombre</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <input pInputText type="text" formControlName="sku" />
                <label>SKU</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <input pInputText type="text" formControlName="barcodes" />
                <label>Códigos de barras (separados por coma)</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <input pInputText type="text" formControlName="uomId" />
                <label>Unidad de medida</label>
              </p-floatLabel>
            <p-floatLabel class="field">
              <p-inputNumber
                formControlName="price"
                [min]="0"
                [minFractionDigits]="2"
                [maxFractionDigits]="2"
              ></p-inputNumber>
              <label>Precio</label>
            </p-floatLabel>
            <p-floatLabel class="field">
              <p-inputNumber
                formControlName="minStock"
                [min]="0"
                [minFractionDigits]="0"
                [maxFractionDigits]="0"
              ></p-inputNumber>
              <label>Stock mínimo</label>
            </p-floatLabel>
            <div class="field toggle">
              <label>Vendible</label>
              <p-toggleSwitch formControlName="sellable"></p-toggleSwitch>
            </div>
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      </p-accordion>
    </p-card>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancelar" severity="secondary" (onClick)="dialogVisible = false"></p-button>
    <p-button label="Guardar" icon="pi pi-check" (onClick)="saveProduct()" [loading]="saving"></p-button>
  </ng-template>
</p-dialog>
