<div class="dialog-cards">
  <p-card class="product-section">
    <ng-template pTemplate="title">Producto</ng-template>
    <div class="product-dialog product-grid" [formGroup]="productForm">
      <p-floatLabel class="field">
        <input pInputText id="name" type="text" formControlName="name" />
        <label for="name">Nombre</label>
      </p-floatLabel>
      <p-floatLabel class="field">
        <p-treeSelect
          #categorySelect
          inputId="categoryId"
          [options]="categoryTree"
          formControlName="categoryNode"
          placeholder="Selecciona una categoría"
          appendTo="body"
          [filter]="true"
          selectionMode="single"
        >
          <ng-template #footer>
            <div class="p-3">
              <p-button
                label="Agregar categoría"
                icon="pi pi-plus"
                severity="secondary"
                text
                size="small"
                [fluid]="true"
                (onClick)="onAddCategoryClick($event)"
              ></p-button>
            </div>
          </ng-template>
        </p-treeSelect>
        <label for="categoryId">Categoría</label>
      </p-floatLabel>
      <div class="field toggle">
        <label for="isActive">Activo</label>
        <p-toggleSwitch inputId="isActive" formControlName="isActive"></p-toggleSwitch>
      </div>
    </div>
  </p-card>

  <p-card class="variants-section">
    <ng-template pTemplate="title">
      <div class="variants-card-header">
        <span>Variantes</span>
        <p-button
          *ngIf="enableVariants"
          icon="pi pi-plus"
          label="Agregar variante"
          size="small"
          (onClick)="openVariantCreate()"
        ></p-button>
      </div>
    </ng-template>

    <p-accordion expandIcon="pi pi-chevron-down" collapseIcon="pi pi-chevron-up">
      <p-accordion-panel [value]="0">
        <p-accordion-header>
          <div class="variant-header">
            <span class="variant-title">
              {{ defaultVariantForm.controls.name.value || 'Variante default' }}
            </span>
            <div class="variant-meta">
              <span>
                Medida:
                {{
                  getMeasurementPreview(
                    defaultVariantForm.controls.quantity.value,
                    defaultVariantForm.controls.uomId.value
                  ) || '—'
                }}
              </span>
              <span>Min: {{ defaultVariantForm.controls.minStock.value | number: '1.0-0':'en-US' }}</span>
            </div>
          </div>
        </p-accordion-header>
        <p-accordion-content>
          <div class="product-dialog" [formGroup]="defaultVariantForm">
            <p-floatLabel class="field">
              <input pInputText id="variantName" type="text" formControlName="name" />
              <label for="variantName">Nombre de variante</label>
            </p-floatLabel>
            <p-floatLabel class="field">
              <input pInputText id="sku" type="text" formControlName="sku" />
              <label for="sku">SKU</label>
            </p-floatLabel>
            <p-floatLabel class="field">
              <input pInputText id="barcodes" type="text" formControlName="barcodes" />
              <label for="barcodes">Códigos de barras (separados por coma)</label>
            </p-floatLabel>
            <div class="uom-grid">
              <p-floatLabel class="field">
                <p-select
                  #uomCategorySelect
                  inputId="uomCategoryId"
                  [options]="uomCategoryOptions"
                  optionLabel="label"
                  optionValue="value"
                  formControlName="uomCategoryId"
                  appendTo="body"
                >
                  <ng-template #footer>
                    <div class="p-3">
                      <p-button
                        label="Agregar categoría UoM"
                        icon="pi pi-plus"
                        severity="secondary"
                        text
                        size="small"
                        [fluid]="true"
                        (onClick)="onAddUomCategoryClick($event)"
                      ></p-button>
                    </div>
                  </ng-template>
                </p-select>
                <label for="uomCategoryId">Categoría UoM</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <p-select
                  #uomUnitSelect
                  inputId="uomId"
                  [options]="getUomOptions(defaultVariantForm.controls.uomCategoryId.value)"
                  optionLabel="label"
                  optionValue="value"
                  formControlName="uomId"
                  appendTo="body"
                >
                  <ng-template #footer>
                    <div class="p-3">
                      <p-button
                        label="Agregar unidad"
                        icon="pi pi-plus"
                        severity="secondary"
                        text
                        size="small"
                        [fluid]="true"
                        (onClick)="onAddUomUnitClick($event)"
                      ></p-button>
                    </div>
                  </ng-template>
                </p-select>
                <label for="uomId">UoM</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <p-inputNumber
                  inputId="quantity"
                  formControlName="quantity"
                  [min]="0"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  locale="en-US"
                ></p-inputNumber>
                <label for="quantity">Valor</label>
              </p-floatLabel>
            </div>
            <p-floatLabel class="field">
              <p-inputNumber
                inputId="minStock"
                formControlName="minStock"
                [min]="0"
                [minFractionDigits]="0"
                [maxFractionDigits]="0"
              ></p-inputNumber>
              <label for="minStock">Stock mínimo</label>
            </p-floatLabel>
          </div>

          <div class="packaging-section">
            <div class="packaging-header">
              <h4>Empaques</h4>
              <p-button
                icon="pi pi-plus"
                label="Agregar empaque"
                size="small"
                (onClick)="addPackagingRow()"
              ></p-button>
            </div>
            <div class="packaging-table" *ngIf="packagingFormArray.controls.length > 0">
              <div class="packaging-row header">
                <span>Nombre</span>
                <span>Unidades</span>
                <span>Precio</span>
                <span>Barcode</span>
                <span>Cod. interno</span>
                <span>Activo</span>
                <span></span>
              </div>
              <div
                class="packaging-row"
                *ngFor="let pack of packagingFormArray.controls; let pIndex = index"
                [formGroup]="pack"
              >
                <p-floatLabel class="field">
                  <p-select
                    #packagingNameSelect
                    [options]="packagingNameOptions"
                    optionLabel="label"
                    optionValue="value"
                    formControlName="name"
                    appendTo="body"
                  >
                    <ng-template #footer>
                      <div class="p-3">
                        <p-button
                          label="Agregar nombre"
                          icon="pi pi-plus"
                          severity="secondary"
                          text
                          size="small"
                          [fluid]="true"
                          (onClick)="onAddPackagingNameClick($event, pIndex, packagingNameSelect)"
                        ></p-button>
                      </div>
                    </ng-template>
                  </p-select>
                  <label>Nombre</label>
                </p-floatLabel>
                <p-floatLabel class="field">
                  <p-inputNumber
                    formControlName="unitsPerPack"
                    [min]="1"
                    [minFractionDigits]="0"
                    [maxFractionDigits]="0"
                    locale="en-US"
                  ></p-inputNumber>
                  <label>Unidades</label>
                </p-floatLabel>
                <p-floatLabel class="field">
                  <p-inputNumber
                    formControlName="price"
                    [min]="0"
                    [minFractionDigits]="2"
                    [maxFractionDigits]="2"
                    locale="en-US"
                  ></p-inputNumber>
                  <label>Precio</label>
                </p-floatLabel>
                <p-floatLabel class="field">
                  <input pInputText type="text" formControlName="barcode" />
                  <label>Barcode</label>
                </p-floatLabel>
                <div class="field barcode-field">
                  <p-floatLabel class="barcode-input">
                    <p-inputGroup>
                      <input pInputText type="text" formControlName="internalBarcode" readonly />
                      <p-button
                        icon="pi pi-refresh"
                        severity="secondary"
                        size="small"
                        [text]="true"
                        [loading]="isPackagingGenerating(pIndex)"
                        [disabled]="isPackagingGenerating(pIndex) || !!pack.controls.internalBarcode.value"
                        (onClick)="generatePackagingInternalBarcode(pIndex)"
                      ></p-button>
                    </p-inputGroup>
                    <label>Código interno</label>
                  </p-floatLabel>
                </div>
                <div class="field toggle">
                  <label>Activo</label>
                  <p-toggleSwitch formControlName="isActive"></p-toggleSwitch>
                </div>
                <p-button
                  icon="pi pi-trash"
                  severity="danger"
                  size="small"
                  text="true"
                  (onClick)="removePackagingRow(pIndex)"
                ></p-button>
              </div>
            </div>
          </div>
        </p-accordion-content>
      </p-accordion-panel>

      <p-accordion-panel *ngFor="let group of variantsFormArray.controls; let i = index" [value]="i + 1">
        <p-accordion-header>
          <div class="variant-header">
            <span class="variant-title">
              {{ group.controls.name.value || ('Variante adicional ' + (i + 1)) }}
            </span>
            <div class="variant-meta">
              <span>
                Medida:
                {{ getMeasurementPreview(group.controls.quantity.value, group.controls.uomId.value) || '—' }}
              </span>
              <span>Min: {{ group.controls.minStock.value | number: '1.0-0':'en-US' }}</span>
            </div>
            <span class="variant-header-actions" (click)="$event.stopPropagation()">
              <p-button
                icon="pi pi-trash"
                severity="danger"
                text="true"
                size="small"
                (onClick)="onRemoveVariant(i, $event)"
              ></p-button>
            </span>
          </div>
        </p-accordion-header>
        <p-accordion-content>
          <div class="product-dialog" [formGroup]="group">
            <p-floatLabel class="field">
              <input pInputText type="text" formControlName="name" />
              <label>Nombre de variante</label>
            </p-floatLabel>
            <p-floatLabel class="field">
              <input pInputText type="text" formControlName="sku" />
              <label>SKU</label>
            </p-floatLabel>
            <p-floatLabel class="field">
              <input pInputText type="text" formControlName="barcodes" />
              <label>Códigos de barras (separados por coma)</label>
            </p-floatLabel>
            <div class="uom-grid">
              <p-floatLabel class="field">
                <p-select
                  #uomCategorySelectItem
                  [options]="uomCategoryOptions"
                  optionLabel="label"
                  optionValue="value"
                  formControlName="uomCategoryId"
                  appendTo="body"
                  (onChange)="onVariantCategoryChange(group)"
                >
                  <ng-template #footer>
                    <div class="p-3">
                      <p-button
                        label="Agregar categoría UoM"
                        icon="pi pi-plus"
                        severity="secondary"
                        text
                        size="small"
                        [fluid]="true"
                        (onClick)="onAddUomCategoryClick($event, i, uomCategorySelectItem)"
                      ></p-button>
                    </div>
                  </ng-template>
                </p-select>
                <label>Categoría UoM</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <p-select
                  #uomUnitSelectItem
                  [options]="getUomOptions(group.controls.uomCategoryId.value)"
                  optionLabel="label"
                  optionValue="value"
                  formControlName="uomId"
                  appendTo="body"
                >
                  <ng-template #footer>
                    <div class="p-3">
                      <p-button
                        label="Agregar unidad"
                        icon="pi pi-plus"
                        severity="secondary"
                        text
                        size="small"
                        [fluid]="true"
                        (onClick)="onAddUomUnitClick($event, i, uomUnitSelectItem)"
                      ></p-button>
                    </div>
                  </ng-template>
                </p-select>
                <label>UoM</label>
              </p-floatLabel>
              <p-floatLabel class="field">
                <p-inputNumber
                  formControlName="quantity"
                  [min]="0"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  locale="en-US"
                ></p-inputNumber>
                <label>Valor</label>
              </p-floatLabel>
            </div>
            <p-floatLabel class="field">
              <p-inputNumber
                formControlName="minStock"
                [min]="0"
                [minFractionDigits]="0"
                [maxFractionDigits]="0"
              ></p-inputNumber>
              <label>Stock mínimo</label>
            </p-floatLabel>
            <div class="field toggle">
              <label>Vendible</label>
              <p-toggleSwitch formControlName="sellable"></p-toggleSwitch>
            </div>
          </div>
        </p-accordion-content>
      </p-accordion-panel>
    </p-accordion>
  </p-card>
</div>

<div class="form-actions">
  <p-button label="Cancelar" severity="secondary" (onClick)="onCancel()" [disabled]="saving"></p-button>
  <p-button label="Guardar" icon="pi pi-check" (onClick)="onSubmit()" [loading]="saving"></p-button>
</div>

<p-confirmDialog></p-confirmDialog>

<p-dialog
  header="Nueva categoría"
  [(visible)]="categoryCreateVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  (onHide)="categorySelect?.hide()"
  [style]="{ width: '420px' }"
>
  <app-category-create-form
    [loading]="savingCategory"
    [categoryTree]="categoryTree"
    (save)="handleCategorySave($event)"
    (cancel)="categoryCreateVisible = false"
  ></app-category-create-form>
  <ng-template #footer>
    <div class="bc-actions bc-actions--end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [disabled]="savingCategory"
        (onClick)="categoryCreateVisible = false"
      ></p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        [loading]="savingCategory"
        [disabled]="savingCategory"
        (onClick)="categoryCreateForm?.onSave()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Nueva categoría UoM"
  [(visible)]="uomCategoryCreateVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  (onHide)="uomCategorySelect?.hide()"
  [style]="{ width: '420px' }"
>
  <app-uom-category-create-form
    [loading]="savingUomCategory"
    (save)="handleUomCategorySave($event)"
    (cancel)="uomCategoryCreateVisible = false"
  ></app-uom-category-create-form>
  <ng-template #footer>
    <div class="bc-actions bc-actions--end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [disabled]="savingUomCategory"
        (onClick)="uomCategoryCreateVisible = false"
      ></p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        [loading]="savingUomCategory"
        [disabled]="savingUomCategory"
        (onClick)="uomCategoryCreateForm?.onSave()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Nueva unidad"
  [(visible)]="uomUnitCreateVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  (onHide)="uomUnitSelect?.hide()"
  [style]="{ width: '420px' }"
>
  <app-uom-unit-create-form
    [loading]="savingUomUnit"
    [uomCategoryOptions]="uomCategoryOptions"
    [categoryId]="uomUnitDialogCategoryId"
    (save)="handleUomUnitSave($event)"
    (cancel)="uomUnitCreateVisible = false"
  ></app-uom-unit-create-form>
  <ng-template #footer>
    <div class="bc-actions bc-actions--end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [disabled]="savingUomUnit"
        (onClick)="uomUnitCreateVisible = false"
      ></p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        [loading]="savingUomUnit"
        [disabled]="savingUomUnit"
        (onClick)="uomUnitCreateForm?.onSave()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Nuevo nombre de empaque"
  [(visible)]="packagingNameCreateVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [style]="{ width: '420px' }"
>
  <app-packaging-name-create-form
    [loading]="savingPackagingName"
    (save)="handlePackagingNameSave($event)"
    (cancel)="packagingNameCreateVisible = false"
  ></app-packaging-name-create-form>
  <ng-template #footer>
    <div class="bc-actions bc-actions--end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [disabled]="savingPackagingName"
        (onClick)="packagingNameCreateVisible = false"
      ></p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        [loading]="savingPackagingName"
        [disabled]="savingPackagingName"
        (onClick)="packagingNameCreateForm?.onSave()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>
